<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">

        <title>Dojo Toolkit dijit.form.FilteringSelect</title>

        <style>
            .dijitValidationTextBox .dijitValidationContainer {
                display: none;
            }
            .dijitMenu {
                border: 1px solid black;
            }
            .dijitMenuItem+.dijitMenuItem {
                border-top: 1px solid black;
            }
            .dijitMenuItem>div {
                display: inline-block;
            }
            .dijitMenuItem>div+div {
                border-left: 1px solid black;
            }
            .name {
                width: 300px;
            }
            .county-name {
                width: 200px;
            }
            .state {
                width: 50px;
            }
            .dijitMenuItemHover, .dijitMenuItemSelected {
                background-color: lightgray;
            }
		</style>
	</head>
	<body>
        <div id="city"></div>
        <input id="cities"/>

        <script src="Cities_in_PA_USA.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.6/dojo/dojo.js"></script>
		<script>
            require(
                ["dojo/_base/declare", "dojo/Deferred", "dojo/dom", "dojo/store/Memory", "dojo/store/util/QueryResults", "dijit/form/FilteringSelect", "dojo/domReady!"],
                function(declare, Deferred, dom, Memory, QueryResults, FilteringSelect) {
                    var CityStore = declare([], {
                        data: Cities_in_PA_USA,
                        idIndex: {},
                        idProperty: "feature_id",
                        constructor: function() {
                            var idIndex = this.idIndex,
                                idProperty = this.idProperty;
                            this.data.forEach(function(city) {
                                idIndex[city[idProperty]] = city;
                            });
                        },
                        get: function(id) {
                            console.log("get", arguments);
                            var city = this.idIndex[id],
                                deferred = new Deferred();

                            setTimeout(function() {
                                deferred.resolve(city);
                            }, 500);

                            return deferred;
                        },
                        getIdentity: function(object) {
                            console.log("getIdentity", arguments);
                            return object[this.idProperty];
                        },
                        query: function(query, options) {
                            var cities = [],
                                deferred = new Deferred();

                            // No wildcard (*) is sent as part of the query b/c the FilteringSelect's queryExpr must be defined w/o one.
                            // "toString" must be called b/c a RegEx is sent. But is has a toString method to get back the raw string.
                            var name = query.name.toString().toLowerCase();
                            this.data.forEach(function(city) {
                                if(city.name.toLowerCase().substr(0, name.length) === name) {
                                    cities.push(city);
                                }
                            });

                            setTimeout(function() {
                                deferred.resolve(cities);
                            }, 500);

                            return QueryResults(deferred);
                        }
                    });

                    new FilteringSelect({
                        autoComplete: true,
                        hasDownArrow: false,
                        queryExpr: "${0}",
                        required: false,
                        searchAttr: "name",
                        store: new CityStore(),
                        labelType: "html",
                        labelFunc: function(item) {
                            return "<div class='name'>" + item.name + "</div><div class='county-name'>" + item.county_name + "</div><div class='state'>" + item.state_abbreviation + "</div>";
                        }
                    }, "cities").on("change", function(city) {
                        dom.byId("city").innerHTML = city;
                    });
                }
            );
        </script>
	</body>
</html>
